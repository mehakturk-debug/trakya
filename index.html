<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trakya Teberru - YÃ¶netim Paneli</title>
    <style>
        :root {
            --bg: #000; --card: #080808; --neon: #f1c40f; 
            --glow: 0 0 25px rgba(241, 196, 15, 0.4); --success: #27ae60;
        }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; overflow: hidden; }
        .main-wrapper { display: flex; height: 100vh; width: 100vw; flex-direction: column; }

        /* KÄ°LÄ°T EKRANI */
        #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .lock-content { background: #0a0a0a; border: 2px solid var(--neon); padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; box-shadow: var(--glow); }

        /* ANA Ä°Ã‡ERÄ°K */
        .content-area { flex: 1; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .master-stats { background: #050505; border: 1px solid var(--success); border-radius: 10px; padding: 10px; text-align: center; margin-bottom: 10px; flex-shrink: 0; }
        .master-val { font-size: 2rem; font-weight: 900; color: var(--success); }

        /* GRID SÄ°STEMÄ° */
        .grid { display: grid; gap: 10px; flex: 1; overflow: hidden; }

        /* KARE KARTLAR */
        .card {
            background: var(--card); border: 1px solid #1a1a1a; border-radius: 10px;
            padding: 10px; cursor: pointer; transition: 0.3s; text-align: center;
            position: relative; display: flex; flex-direction: column; justify-content: center; 
            overflow: hidden; aspect-ratio: 1 / 1; 
        }
        .card:hover { background: var(--neon); color: #000 !important; border-color: #fff; }
        .card:hover * { color: #000 !important; }

        .plaka-neon { position: absolute; top: 5px; right: 5px; font-size: 2.2rem; font-weight: 900; color: var(--neon); text-shadow: 0 0 10px var(--neon); z-index: 1; }
        .main-stat { font-size: 1.2rem; color: var(--success); font-weight: 900; z-index: 2; }
        .sub-info { font-size: 0.75rem; color: #777; font-weight: bold; z-index: 2; }
        .title-text { font-size: 1.4rem; color: var(--neon); font-weight: 900; z-index: 2; margin-bottom: 5px; }

        /* DÃœKKANLAR */
        .shop-grid { display: grid; gap: 10px; flex: 1; overflow-y: auto; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        .shop-card { background: #0a0a0a; border: 1px solid #222; border-top: 4px solid var(--neon); padding: 10px; border-radius: 10px; aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: space-between; }

        /* PANEL */
        .panel-trigger { position: fixed; right: 0; top: 50%; transform: translateY(-50%) rotate(-90deg); transform-origin: right bottom; background: var(--neon); color: #000; padding: 8px 15px; font-weight: 900; cursor: pointer; z-index: 1001; border-radius: 5px 5px 0 0; }
        .side-panel { position: fixed; right: -320px; top: 0; width: 300px; height: 100%; background: #0a0a0a; border-left: 2px solid var(--neon); transition: 0.4s; z-index: 1000; padding: 20px; overflow-y: auto; }
        .side-panel.open { right: 0; }
        
        .btn { border: 1px solid var(--neon); color: var(--neon); padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; text-transform: uppercase; text-decoration: none; text-align: center; font-size: 0.8rem; display: block; margin-top: 5px; }
        .btn:hover { background: var(--neon); color: #000; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; background: #111; border: 1px solid #333; color: #fff; border-radius: 4px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="lockScreen">
    <div class="lock-content">
        <h2 style="color:var(--neon)">ERÄ°ÅžÄ°M TALEBÄ°</h2>
        <div id="authContent">
            <p style="font-size: 0.8rem; color: #888;">ID: <span id="dispId" style="color:var(--neon)"></span></p>
            <input type="text" id="reqName" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z">
            <button class="btn" onclick="sendAuthRequest()" style="background:var(--neon); color:#000; width:100%;">TALEBÄ° GÃ–NDER</button>
        </div>
    </div>
</div>

<div class="main-wrapper">
    <div class="panel-trigger" onclick="togglePanel()">HIZLI KAYIT</div>
    
    <div class="side-panel" id="sidePanel">
        <h3 style="color:var(--neon); margin-top:0;">YENÄ° KAYIT</h3>
        <select id="f_city" onchange="updateDists()"><option>TEKÄ°RDAÄž</option><option>EDÄ°RNE</option><option>KIRKLARELÄ°</option><option>Ã‡ANAKKALE</option></select>
        <select id="f_dist"></select>
        <input type="text" id="f_name" placeholder="DÃ¼kkan AdÄ±">
        <input type="text" id="f_owner" placeholder="Sahibi">
        <input type="text" id="f_phone" placeholder="Telefon">
        <input type="number" id="f_amount" placeholder="Tutar">
        <textarea id="f_note" placeholder="Notlar..."></textarea>
        <button class="btn" style="background:var(--success); color:#fff; border:none;" onclick="saveEntry()">KAYDET (1071)</button>
        <button class="btn" onclick="togglePanel()">KAPAT</button>
    </div>

    <div class="content-area">
        <div class="master-stats">
            <h1 style="color:var(--neon); font-size:0.7rem; margin:0;">TRAKYA GENEL TOPLAM</h1>
            <div id="totalDisplay" class="master-val">0 TL</div>
        </div>
        <div id="breadcrumb" style="text-align:center; color:var(--neon); font-weight:900; margin-bottom:5px;"></div>
        <button id="backBtn" class="btn hidden" onclick="goBack()" style="width:auto; margin-bottom:10px; align-self:center;">â¬… GERÄ°</button>
        <div id="mainGrid" class="grid"></div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGZAKNAhKKD_Xeoev9tfnUf4ap83V0sVV9oepF3-jQN3qZa1TX18c3YhNzG0aN9a14Bw/exec";
    
    let deviceId = localStorage.getItem('trakya_id') || ('TRK-' + Math.random().toString(36).substr(2, 6).toUpperCase());
    localStorage.setItem('trakya_id', deviceId);
    document.getElementById('dispId').innerText = deviceId;

    const cityData = { "TEKÄ°RDAÄž": "59", "EDÄ°RNE": "22", "KIRKLARELÄ°": "39", "Ã‡ANAKKALE": "17" };
    const dists = {
        "TEKÄ°RDAÄž": ["SÃ¼leymanpaÅŸa", "Ã‡orlu", "Ã‡erkezkÃ¶y", "Ergene", "KapaklÄ±", "Malkara", "Saray", "Hayrabolu", "ÅžarkÃ¶y", "MuratlÄ±", "MarmaraereÄŸlisi"],
        "EDÄ°RNE": ["Merkez", "KeÅŸan", "UzunkÃ¶prÃ¼", "Ä°psala", "Havsa", "MeriÃ§", "Enez", "SÃ¼loÄŸlu", "LalapaÅŸa"],
        "KIRKLARELÄ°": ["Merkez", "LÃ¼leburgaz", "Babaeski", "Vize", "PÄ±narhisar", "DemirkÃ¶y", "PehlivankÃ¶y", "KofÃ§az"],
        "Ã‡ANAKKALE": ["Merkez", "Biga", "Ã‡an", "Gelibolu", "Yenice", "AyvacÄ±k", "Ezine", "BayramiÃ§", "Lapseki", "Eceabat", "GÃ¶kÃ§eada", "Bozcaada"]
    };

    let fullDb = [], currentCity = null, currentDist = null;

    async function checkAuth() {
        try {
            const res = await fetch(`${SCRIPT_URL}?deviceId=${deviceId}&t=${Date.now()}`);
            const result = await res.json();
            if (result.authorized) {
                document.getElementById('lockScreen').style.display = 'none';
                fullDb = result.data.slice(1).filter(r => r[0] && r[3]).map(r => ({
                    city: r[0].toString().toUpperCase(), dist: r[1].toString().toUpperCase(),
                    name: r[3], owner: r[4], phone: r[5],
                    amount: parseInt(r[6].toString().replace(/[^0-9]/g,'')) || 0,
                    note: r[7]||"", maps: r[9]
                }));
                updateMaster(); render();
            }
        } catch (e) { console.log("Kontrol..."); }
    }

    async function sendAuthRequest() {
        const name = document.getElementById('reqName').value;
        if(!name) return alert("Ä°sim yazÄ±n.");
        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: "AUTH_REQUEST", deviceId: deviceId, name: name }) });
        document.getElementById('authContent').innerHTML = "<p style='color:var(--success)'>Talep iletildi. Onay bekleyin...</p>";
        setInterval(checkAuth, 5000);
    }

    async function saveEntry() {
        if(prompt("Åžifre:") !== "1071") return;
        const data = { city: document.getElementById('f_city').value, dist: document.getElementById('f_dist').value.toUpperCase(), name: document.getElementById('f_name').value, owner: document.getElementById('f_owner').value, phone: document.getElementById('f_phone').value, amount: document.getElementById('f_amount').value, note: document.getElementById('f_note').value, type: "ENTRY" };
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
        alert("Eklendi!"); checkAuth();
    }

    function render() {
        const grid = document.getElementById('mainGrid'); grid.innerHTML = "";
        
        if (!currentCity) {
            document.getElementById('backBtn').classList.add('hidden');
            document.getElementById('breadcrumb').innerText = "Ä°L SEÃ‡Ä°NÄ°Z";
            grid.className = "grid";
            grid.style.gridTemplateColumns = "repeat(auto-fit, minmax(130px, 1fr))";
            grid.style.gridTemplateRows = "repeat(auto-fit, minmax(130px, 1fr))";
            Object.keys(cityData).sort((a,b) => getSum(b) - getSum(a)).forEach(city => {
                const div = document.createElement('div'); div.className = "card";
                div.onclick = () => { currentCity = city; render(); };
                div.innerHTML = `<div class="plaka-neon">${cityData[city]}</div>
                    <div class="title-text">${city}</div>
                    <div class="sub-info">${dists[city].length} Ä°LÃ‡E | ${fullDb.filter(i=>i.city===city).length} ADRES</div>
                    <div class="main-stat">${getSum(city).toLocaleString()} TL</div>`;
                grid.appendChild(div);
            });
        } else if (!currentDist) {
            document.getElementById('backBtn').classList.remove('hidden');
            document.getElementById('breadcrumb').innerText = "ðŸ“ " + currentCity;
            
            // SADECE Ä°LÃ‡ELERDE 2 SATIRLI SABÄ°T YAPI
            grid.className = "grid";
            grid.style.gridTemplateRows = "repeat(2, 1fr)"; 
            grid.style.gridTemplateColumns = `repeat(auto-fit, minmax(100px, 1fr))`;

            dists[currentCity].map(d => d.toUpperCase()).sort((a,b) => getSum(currentCity, b) - getSum(currentCity, a)).forEach(dist => {
                const div = document.createElement('div'); div.className = "card";
                div.onclick = () => { currentDist = dist; render(); };
                div.innerHTML = `<div class="title-text" style="font-size:1rem;">${dist}</div>
                    <div class="sub-info">${fullDb.filter(i=>i.city===currentCity && i.dist===dist).length} ADRES</div>
                    <div class="main-stat" style="font-size:1rem;">${getSum(currentCity, dist).toLocaleString()} TL</div>`;
                grid.appendChild(div);
            });
        } else {
            document.getElementById('breadcrumb').innerText = `ðŸ“ ${currentCity} / ${currentDist}`;
            grid.className = "shop-grid";
            grid.style.gridTemplateRows = "none";
            grid.style.gridTemplateColumns = "repeat(auto-fill, minmax(200px, 1fr))";
            fullDb.filter(i => i.city === currentCity && i.dist === currentDist).sort((a,b) => b.amount - a.amount).forEach(shop => {
                const div = document.createElement('div'); div.className = "shop-card";
                div.innerHTML = `<div><div style="color:var(--success); float:right; font-weight:900;">${shop.amount.toLocaleString()} TL</div>
                    <h3 style="color:var(--neon); margin:0;">${shop.name}</h3>
                    <div style="font-size:0.75rem; color:#777; margin-top:5px;"><b>Sahibi:</b> ${shop.owner}</div>
                    <div style="font-size:0.75rem; color:#777;"><b>Tel:</b> ${shop.phone}</div>
                    <div style="font-size:0.7rem; color:#ccc; font-style:italic; margin-top:5px;">${shop.note}</div></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                        <a href="${shop.maps}" target="_blank" class="btn">KONUM</a>
                        <a href="tel:${shop.phone}" class="btn" style="background:var(--success); color:#fff; border:none;">ARA</a>
                    </div>`;
                grid.appendChild(div);
            });
        }
    }

    function getSum(c, d = null) {
        let f = fullDb.filter(i => i.city === c);
        if(d) f = f.filter(i => i.dist === d);
        return f.reduce((s, i) => s + i.amount, 0);
    }

    function updateMaster() { document.getElementById('totalDisplay').innerText = fullDb.reduce((s, i) => s + i.amount, 0).toLocaleString() + " TL"; }
    function togglePanel() { document.getElementById('sidePanel').classList.toggle('open'); }
    function updateDists() { const c = document.getElementById('f_city').value; document.getElementById('f_dist').innerHTML = dists[c].map(d => `<option>${d.toUpperCase()}</option>`).join(""); }
    function goBack() { if(currentDist) { currentDist = null; } else { currentCity = null; } render(); }
    
    updateDists(); checkAuth();
</script>
</body>
</html>
